<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ULTRAalerts Control Panel</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 40px;
      background-color: #f9f9f9;
    }
    h1 {
      color: #333;
    }
    .status {
      font-weight: bold;
      color: green;
    }
    .status.off {
      color: red;
    }
    textarea {
      width: 100%;
      height: 100px;
      margin-bottom: 10px;
    }
    button {
      margin: 5px 0;
      padding: 10px 15px;
      font-size: 16px;
    }
    #alerts {
      margin-top: 20px;
    }
    .alert-item {
      background-color: #fff;
      padding: 10px;
      margin-bottom: 5px;
      border-left: 5px solid #2196F3;
    }
  </style>
</head>
<body>
  <h1>ULTRAalerts Control Panel</h1>
  <p>Status: <span id="status" class="status">Loading...</span></p>

  <h2>Toggle System ON/OFF</h2>
  <button onclick="toggleStatus()">Toggle Status</button>

  <h2>Manage Locations</h2>
  <textarea id="locations" placeholder="Enter zone codes, one per line..."></textarea>
  <button onclick="saveLocations()">Save Locations</button>

  <h2>Send Alerts</h2>
  <button onclick="sendTestAlert()">Send Test Alert</button>

  <h2>Recent Sent Alerts</h2>
  <div id="alerts">Loading...</div>

  <script>
    const PAT = "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"; // 🔐 Replace with your GitHub Personal Access Token
    const GIST_ID = "cc77ca8c82ed2627b2ea5d57e4743efa";
    const USERNAME = "claytonsweather";
    const REPO = "ULTRAalerts";

    const headers = {
      "Authorization": `token ${PAT}`,
      "Accept": "application/vnd.github.v3+json"
    };

    async function fetchConfig() {
      try {
        const res = await fetch(`https://api.github.com/repos/${USERNAME}/${REPO}/contents/config.json`, { headers });
        const data = await res.json();
        const content = JSON.parse(atob(data.content));
        document.getElementById('status').textContent = content.status ? "ON" : "OFF";
        document.getElementById('status').className = content.status ? "status" : "status off";
        document.getElementById('locations').value = content.locations.join('\n');
      } catch (err) {
        console.error("Error fetching config:", err);
        document.getElementById('status').textContent = "Error loading config";
        document.getElementById('status').className = "status off";
      }
    }

    async function toggleStatus() {
      try {
        const res = await fetch(`https://api.github.com/repos/${USERNAME}/${REPO}/contents/config.json`, { headers });
        const data = await res.json();
        const content = JSON.parse(atob(data.content));
        content.status = !content.status;
        const updatedContent = btoa(JSON.stringify(content, null, 2));
        await fetch(`https://api.github.com/repos/${USERNAME}/${REPO}/contents/config.json`, {
          method: "PUT",
          headers,
          body: JSON.stringify({
            message: "Toggle status",
            content: updatedContent,
            sha: data.sha
          })
        });
        fetchConfig();
      } catch (err) {
        console.error("Error toggling status:", err);
      }
    }

    async function saveLocations() {
      try {
        const res = await fetch(`https://api.github.com/repos/${USERNAME}/${REPO}/contents/config.json`, { headers });
        const data = await res.json();
        const content = JSON.parse(atob(data.content));
        const locations = document.getElementById('locations').value.split('\n').map(l => l.trim()).filter(l => l);
        content.locations = locations;
        const updatedContent = btoa(JSON.stringify(content, null, 2));
        await fetch(`https://api.github.com/repos/${USERNAME}/${REPO}/contents/config.json`, {
          method: "PUT",
          headers,
          body: JSON.stringify({
            message: "Update locations",
            content: updatedContent,
            sha: data.sha
          })
        });
        alert("Locations updated successfully.");
      } catch (err) {
        console.error("Error saving locations:", err);
        alert("Failed to update locations.");
      }
    }

    async function sendTestAlert() {
      try {
        const alertUrl = `https://example.com/test-alert-${Date.now()}`;
        const res = await fetch(`https://api.github.com/gists/${GIST_ID}`, { headers });
        const gistData = await res.json();
        const alerts = JSON.parse(gistData.files["sent_alerts.json"].content);
        if (alerts.includes(alertUrl)) {
          alert("Test alert already sent.");
          return;
        }
        alerts.push(alertUrl);
        await fetch(`https://api.github.com/gists/${GIST_ID}`, {
          method: "PATCH",
          headers,
          body: JSON.stringify({
            files: {
              "sent_alerts.json": {
                content: JSON.stringify(alerts, null, 2)
              }
            }
          })
        });
        loadAlerts();
        alert("Test alert sent successfully.");
      } catch (err) {
        console.error("Error sending test alert:", err);
        alert("Failed to send test alert.");
      }
    }

    async function loadAlerts() {
      try {
        const res = await fetch(`https://api.github.com/gists/${GIST_ID}`, { headers });
        const gistData = await res.json();
        const alerts = JSON.parse(gistData.files["sent_alerts.json"].content);
        const alertsDiv = document.getElementById('alerts');
        alertsDiv.innerHTML = '';
        if (alerts.length === 0) {
          alertsDiv.textContent = "No alerts sent yet.";
          return;
        }
        alerts.slice().reverse().forEach(alert => {
          const div = document.createElement('div');
          div.className = 'alert-item';
          div.textContent = alert;
          alertsDiv.appendChild(div);
        });
      } catch (err) {
        console.error("Error loading alerts:", err);
        document.getElementById('alerts').textContent = "Error loading alert log.";
      }
    }

    // Initialize
    fetchConfig();
    loadAlerts();
  </script>
</body>
</html>

